// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model MenuItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String   @db.ObjectId
  section     MenuSection? @relation(fields: [menuSectionId], references: [id])
  menuSectionId String? @db.ObjectId
  name        String
  description String
  price       Float
  category    String   @default("general")
  image       String?
  available   Boolean  @default(true)
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      OrderItem[]
}

model Order {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String   @db.ObjectId
  customer    Customer? @relation(fields: [customerId], references: [id])
  customerId  String?  @db.ObjectId
  items       OrderItem[]
  subtotalAmount Float?
  taxAmount   Float?   @default(0)
  deliveryFee Float?   @default(0)
  tipAmount   Float?   @default(0)
  platformFee Float?   @default(0)
  totalAmount Float
  status      String   @default("pending") // pending, confirmed, preparing, ready, completed, cancelled
  fulfillmentMethod String   @default("pickup") // pickup, delivery
  deliveryPartner  String?
  paymentMethod    String?   // apple_pay, card, cash, etc.
  customerName String?
  customerEmail String?
  customerPhone String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model OrderItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id])
  menuItemId  String   @db.ObjectId
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String   @db.ObjectId
  order       Order    @relation(fields: [orderId], references: [id])
  orderId     String   @db.ObjectId
  quantity    Int
  price       Float    // Price at time of order
  notes       String?
}

model Tenant {
  id             String            @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  slug           String            @unique
  domain         String?
  customDomain   String?
  contactEmail   String?
  contactPhone   String?
  addressLine1   String?
  addressLine2   String?
  city           String?
  state          String?
  postalCode     String?
  country        String?
  logoUrl        String?
  heroImageUrl   String?
  heroTitle      String?
  heroSubtitle   String?
  primaryColor   String?           @default("#dc2626")
  secondaryColor String?           @default("#f59e0b")
  featureFlags   String[]          @default([])
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  settings       TenantSettings?
  integrations   TenantIntegration?
  customers      Customer[]
  customerSessions CustomerSession[]
  menuSections   MenuSection[]
  menuItems      MenuItem[]
  orders         Order[]
  orderItems     OrderItem[]
  integrationLogs IntegrationLog[]
}

model TenantSettings {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  tenantId          String   @unique @db.ObjectId
  tagline           String?
  about             String?
  socialInstagram   String?
  socialFacebook    String?
  socialTikTok      String?
  socialYouTube     String?
  deliveryRadiusMi  Int?     @default(5)
  minimumOrderValue Float?   @default(0)
  currency          String?  @default("USD")
  timeZone          String?  @default("America/Los_Angeles")
  operatingHours    Json?
  membershipProgram Json?
  upsellBundles     Json?
  accessibilityDefaults Json?
  branding          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model TenantIntegration {
  id                     String   @id @default(auto()) @map("_id") @db.ObjectId
  tenant                 Tenant   @relation(fields: [tenantId], references: [id])
  tenantId               String   @unique @db.ObjectId
  doorDashStoreId        String?
  doorDashOAuthToken     String?
  cloverMerchantId       String?
  stripeAccountId        String?
  cloverAccessToken      String?
  squareLocationId       String?
  squareAccessToken      String?
  taxProvider            String?  @default("builtin") // builtin, avalara, taxjar, square
  taxConfig              Json?
  paymentProcessor       String?  @default("stripe")
  paymentConfig          Json?
  printerType            String?  @default("bluetooth")
  printerEndpoint        String?
  applePayMerchantId     String?
  applePayPaymentProcessingCertificate String?
  autoAcceptOrders       Boolean? @default(false)
  platformPercentFee     Float?   @default(0.029)
  platformFlatFee        Float?   @default(0.3)
  defaultTaxRate         Float?   @default(0.0825)
  deliveryBaseFee        Float?   @default(4.99)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model MenuSection {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  tenantId      String         @db.ObjectId
  name          String
  description   String?
  type          MenuSectionType @default(RESTAURANT)
  position      Int             @default(0)
  hero          Boolean         @default(false)
  imageUrl      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  menuItems     MenuItem[]
}

enum MenuSectionType {
  RESTAURANT
  BAKERY
  GROCERY
  BEVERAGE
  SPECIAL
  OTHER
}

model Customer {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String   @db.ObjectId
  name        String?
  email       String?
  phone       String?
  emailVerified DateTime?
  loyaltyPoints Int    @default(0)
  membershipTier String?
  accessibilityPreferences Json?
  orders      Order[]
  sessions    CustomerSession[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([tenantId, email])
  @@index([tenantId, phone])
}

model IntegrationLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String   @db.ObjectId
  source    String
  level     String   @default("info")
  message   String?
  payload   Json?
  createdAt DateTime @default(now())
}

model CustomerSession {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String   @db.ObjectId
  customer    Customer @relation(fields: [customerId], references: [id])
  customerId  String   @db.ObjectId
  token       String   @unique
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  @@index([tenantId, token])
}
