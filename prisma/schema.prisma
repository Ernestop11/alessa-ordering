// Prisma schema converted for PostgreSQL
// learn more at https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TenantStatus {
  PENDING_REVIEW
  READY_FOR_APPROVAL
  APPROVED
  LIVE
  PAUSED
  ARCHIVED
}

model MenuItem {
  id                    String       @id @default(uuid())
  tenantId              String
  menuSectionId         String?
  name                  String
  description           String
  price                 Float
  category              String       @default("general")
  image                 String?
  gallery               Json?
  available             Boolean      @default(true)
  isFeatured            Boolean      @default(false)
  tags                  String[]     @default([])
  customizationRemovals String[]     @default([])
  customizationAddons   Json?
  // Time-specific availability (e.g., Taco Tuesday)
  timeSpecificEnabled   Boolean      @default(false)
  timeSpecificDays      Int[]        @default([]) // 0=Sunday, 1=Monday, etc.
  timeSpecificStartTime String? // e.g., "11:00"
  timeSpecificEndTime   String? // e.g., "15:00"
  timeSpecificPrice     Float? // Override price during time window
  timeSpecificLabel     String? // e.g., "Taco Tuesday Special"
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  tenant                Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  section               MenuSection? @relation(fields: [menuSectionId], references: [id], onDelete: SetNull)
  orders                OrderItem[]
  blockMenuItems        TenantBlockMenuItem[]
}

model CateringPackage {
  id                    String           @id @default(uuid())
  tenantId              String
  cateringSectionId     String?
  name                  String
  description           String
  pricePerGuest         Float
  price                 Float?
  category              String           @default("popular")
  image                 String?
  gallery               Json?
  badge                 String?
  customizationRemovals String[]         @default([])
  customizationAddons   Json?
  available             Boolean          @default(true)
  displayOrder          Int              @default(0)
  // Time-specific availability (e.g., Weekend Special)
  timeSpecificEnabled   Boolean          @default(false)
  timeSpecificDays      Int[]            @default([]) // 0=Sunday, 1=Monday, etc.
  timeSpecificStartTime String? // e.g., "11:00"
  timeSpecificEndTime   String? // e.g., "15:00"
  timeSpecificPrice     Float? // Override price during time window
  timeSpecificLabel     String? // e.g., "Weekend Special"
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  tenant                Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  section               CateringSection? @relation(fields: [cateringSectionId], references: [id], onDelete: SetNull)
}

model CateringSection {
  id          String            @id @default(uuid())
  tenantId    String
  name        String
  description String?
  position    Int               @default(0)
  imageUrl    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  tenant      Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  packages    CateringPackage[]
}

model GroceryItem {
  id               String    @id @default(uuid())
  tenantId         String
  name             String
  description      String
  price            Float
  category         String    @default("general") // e.g., "produce", "dairy", "snacks", "beverages"
  unit             String? // e.g., "lb", "each", "gallon", "dozen"
  image            String?
  gallery          Json?
  available        Boolean   @default(true)
  stockQuantity    Int? // Optional inventory tracking
  tags             String[]  @default([])
  displayOrder     Int       @default(0)
  taxPercentage    Float? // Tax rate (e.g., 8.5 for 8.5%)
  expirationDate   DateTime? // Optional expiration/best-by date
  isWeekendSpecial Boolean   @default(false) // Weekend promotion flag
  weekendPrice     Float? // Special weekend pricing
  weekendStartDate DateTime? // When weekend special starts
  weekendEndDate   DateTime? // When weekend special ends
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
  @@index([expirationDate])
  @@index([isWeekendSpecial])
}

model GroceryBundle {
  id           String   @id @default(uuid())
  tenantId     String
  name         String
  description  String
  price        Float
  category     String   @default("combo") // e.g., "combo", "meal-kit", "special"
  image        String?
  gallery      Json? // Array of image URLs
  available    Boolean  @default(true)
  badge        String? // e.g., "Popular", "Best Value"
  items        Json // Array of {groceryItemId, quantity, name}
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
}

model Order {
  id                   String      @id @default(uuid())
  tenantId             String
  customerId           String?
  subtotalAmount       Float?
  taxAmount            Float?      @default(0)
  deliveryFee          Float?      @default(0)
  tipAmount            Float?      @default(0)
  platformFee          Float?      @default(0)
  totalAmount          Float
  paymentIntentId      String?     @unique
  status               String      @default("pending")
  fulfillmentMethod    String      @default("pickup")
  deliveryPartner      String?     // 'uber', 'doordash', 'self'
  deliveryStatus       String?     // 'pending', 'picking_up', 'en_route', 'delivered', 'cancelled'
  deliveryTrackingUrl  String?
  uberDeliveryId       String?
  doordashDeliveryId   String?
  deliveryAddress      Json?       // Full address object for delivery
  deliveryInstructions String?
  deliveryQuoteId      String?     // Quote ID from delivery partner
  paymentMethod        String?
  customerName         String?
  customerEmail        String?
  customerPhone        String?
  notes                String?
  scheduledPickupTime  DateTime?   // When customer wants to pick up (null = ASAP)
  acknowledgedAt       DateTime?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  tenant               Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer             Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items                OrderItem[]
  selfDelivery         SelfDelivery?
  // Group order support
  groupOrderId         String?
  participantName      String?       // Who this order is for (for labeling in group orders)
  groupOrder           GroupOrder?   @relation(fields: [groupOrderId], references: [id], onDelete: SetNull)
}

model CateringInquiry {
  id            String    @id @default(uuid())
  tenantId      String
  customerName  String
  customerEmail String
  customerPhone String
  eventDate     DateTime?
  guestCount    Int?
  message       String?
  status        String    @default("new") // new, contacted, quoted, booked, cancelled
  respondedAt   DateTime?
  responseNotes String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
}

model PaymentSession {
  id              String   @id @default(uuid())
  tenantId        String
  paymentIntentId String   @unique
  amount          Int
  currency        String   @default("usd")
  status          String   @default("pending")
  orderId         String?
  orderData       Json
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([paymentIntentId])
  @@index([status])
}

model TaxRemittance {
  id                  String    @id @default(uuid())
  tenantId            String
  periodStart         DateTime
  periodEnd           DateTime
  totalTaxCollected   Float
  totalTaxRemitted    Float     @default(0)
  status              String    @default("pending") // pending, processing, completed, failed
  remittanceDate      DateTime?
  remittanceMethod    String? // automatic, manual
  remittanceReference String? // Transaction ID or reference number
  reportData          Json? // Tax report details
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  taxChecks       TaxCheck[]
  achPayments     TaxAchPayment[]

  @@index([tenantId])
  @@index([status])
  @@index([periodStart, periodEnd])
}

// Accountant model for CPA portal
model Accountant {
  id               String   @id @default(uuid())
  email            String   @unique
  name             String
  firmName         String?
  phone            String?
  magicLinkToken   String?  @unique
  magicLinkExpiry  DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenantAccess     AccountantTenantAccess[]
}

model AccountantTenantAccess {
  id           String     @id @default(uuid())
  accountantId String
  tenantId     String
  accessLevel  String     @default("view")  // view, export, manage
  grantedAt    DateTime   @default(now())
  grantedBy    String?    // admin user who granted access

  accountant   Accountant @relation(fields: [accountantId], references: [id], onDelete: Cascade)
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([accountantId, tenantId])
  @@index([accountantId])
  @@index([tenantId])
}

// Tax check printing
model TaxCheck {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  remittanceId    String?
  remittance      TaxRemittance? @relation(fields: [remittanceId], references: [id], onDelete: SetNull)

  checkNumber     Int
  payee           String   // "California CDTFA" etc
  amount          Float
  memo            String?
  status          String   @default("pending")  // pending, printed, mailed, cleared
  printedAt       DateTime?
  clearedAt       DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([remittanceId])
  @@index([status])
}

// Remitian ACH integration
model TaxAchPayment {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  remittanceId    String
  remittance      TaxRemittance @relation(fields: [remittanceId], references: [id], onDelete: Cascade)

  remitianPaymentId String?  // External Remitian ID
  recipientType   String     // state, city, county
  recipientName   String     // "California CDTFA"
  routingNumber   String
  accountNumber   String     // Encrypted
  amount          Float
  status          String     @default("pending")
  processedAt     DateTime?
  confirmationNo  String?
  errorMessage    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([remittanceId])
  @@index([status])
}

model OrderItem {
  id           String    @id @default(uuid())
  menuItemId   String    // Can reference MenuItem.id or GroceryItem.id based on itemType
  tenantId     String
  orderId      String
  quantity     Int
  price        Float
  notes        String?
  itemType     String?   // 'food', 'grocery', or 'bakery' - tracks item category for fulfillment
  menuItemName String?   // Denormalized name for display (since menuItemId may reference different tables)
  menuItem     MenuItem? @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order        Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Tenant {
  id                     String             @id @default(uuid())
  name                   String
  slug                   String             @unique
  domain                 String?
  customDomain           String?
  // Sub-tenant relationship (e.g., El Hornito is a sub-tenant of La Poblanita)
  parentTenantId         String?
  parentTenant           Tenant?            @relation("SubTenants", fields: [parentTenantId], references: [id], onDelete: SetNull)
  subTenants             Tenant[]           @relation("SubTenants")
  contactEmail           String?
  contactPhone           String?
  addressLine1           String?
  addressLine2           String?
  city                   String?
  state                  String?
  postalCode             String?
  country                String?
  logoUrl                String?
  heroImageUrl           String?
  heroTitle              String?
  heroSubtitle           String?
  primaryColor           String?            @default("#dc2626")
  secondaryColor         String?            @default("#f59e0b")
  status                 TenantStatus       @default(PENDING_REVIEW)
  statusNotes            String?
  statusUpdatedAt        DateTime?          @default(now())
  subscriptionPlan       String?
  subscriptionMonthlyFee Float              @default(0)
  subscriptionAddons     String[]           @default([])
  featureFlags           String[]           @default([])
  stripeCustomerId       String?            // Stripe customer ID for subscriptions
  // Email domain verification for custom sender addresses (Resend)
  emailDomainVerified    Boolean            @default(false)
  resendDomainId         String?            // Resend's domain ID for API calls
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  settings               TenantSettings?
  integrations           TenantIntegration?
  customers              Customer[]
  customerSessions       CustomerSession[]
  menuSections           MenuSection[]
  menuItems              MenuItem[]
  frontendSections       FrontendSection[]
  cateringSections       CateringSection[]
  cateringPackages       CateringPackage[]
  groceryItems           GroceryItem[]
  groceryBundles         GroceryBundle[]
  orders                 Order[]
  orderItems             OrderItem[]
  integrationLogs        IntegrationLog[]
  paymentSessions        PaymentSession[]
  cateringInquiries      CateringInquiry[]
  referrals              TenantReferral[]
  tenantSyncs            TenantSync[]
  ecosystemEvents        EcosystemEvent[]
  crmActivities          CRMActivity[]
  crmNotes               CRMNote[]
  convertedFromLead      Lead?              @relation("LeadToTenant")
  productSubscriptions   TenantProduct[]    @relation("TenantProducts")
  taxRemittances         TaxRemittance[]
  taxChecks              TaxCheck[]
  taxAchPayments         TaxAchPayment[]
  accountantAccess       AccountantTenantAccess[]
  template               TenantTemplate?
  drivers                Driver[]
  groupOrders            GroupOrder[]
  customerContacts       CustomerContact[]
  // Wash Service relations
  fleets                 Fleet[]
  trucks                 Truck[]
  washRecords            WashRecord[]
  washEmployees          WashEmployee[]
  employeeShifts         EmployeeShift[]
  washInvoices           WashInvoice[]
  supplyLogs             SupplyLog[]

  @@index([status])
}

model TenantSettings {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  tagline               String?
  about                 String?
  socialInstagram       String?
  socialFacebook        String?
  socialTikTok          String?
  socialYouTube         String?
  deliveryRadiusMi      Int?     @default(5)
  minimumOrderValue     Float?   @default(0)
  currency              String?  @default("USD")
  timeZone              String?  @default("America/Los_Angeles")
  operatingHours        Json?
  membershipProgram     Json?
  upsellBundles         Json?
  rewards               Json? // Array of Reward objects
  emailOffers           Json? // Array of EmailOffer objects
  accessibilityDefaults Json?
  branding              Json?
  cateringTabConfig     Json?
  frontendConfig        Json?
  cateringGallery       String[] @default([])
  rewardsGallery        String[] @default([])
  isOpen                Boolean? @default(true)
  templateType          String?  @default("restaurant")
  gradientFrom          String?
  gradientVia           String?
  gradientTo            String?
  templateConfig        Json?
  enabledAddOns         String[] @default([])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantIntegration {
  id                                   String    @id @default(uuid())
  tenantId                             String    @unique
  doorDashStoreId                      String?
  doorDashOAuthToken                   String?
  // Uber Direct OAuth
  uberOAuthAccessToken                 String?
  uberOAuthRefreshToken                String?
  uberOAuthExpiresAt                   DateTime?
  uberMerchantId                       String?
  uberOnboardingStatus                 String?   @default("not_connected") // not_connected, pending, connected, failed
  uberClientId                         String?
  uberClientSecret                     String?
  uberCustomerId                       String?
  uberSandbox                          Boolean?  @default(true)
  // DoorDash Drive OAuth
  doordashAccessToken                  String?
  doordashRefreshToken                 String?
  doordashExpiresAt                    DateTime?
  doordashBusinessId                   String?
  doordashOnboardingStatus             String?   @default("not_connected") // not_connected, pending, connected, failed
  cloverMerchantId                     String?
  cloverApiKey                         String?
  stripeAccountId                      String?
  stripeOnboardingComplete             Boolean?  @default(false)
  stripeChargesEnabled                 Boolean?  @default(false)
  stripePayoutsEnabled                 Boolean?  @default(false)
  stripeDetailsSubmitted               Boolean?  @default(false)
  stripeOnboardedAt                    DateTime?
  cloverAccessToken                    String?
  squareLocationId                     String?
  squareAccessToken                    String?
  taxProvider                          String?   @default("builtin")
  taxConfig                            Json?
  taxRemittanceEnabled                 Boolean?  @default(false)
  taxRemittanceSchedule                String?   @default("monthly") // monthly, quarterly
  taxEscrowAccountId                   String? // Stripe Connect account for tax escrow
  paymentProcessor                     String?   @default("stripe")
  paymentConfig                        Json?
  printerType                          String?   @default("bluetooth")
  printerEndpoint                      String?
  printerConfig                        Json?
  applePayMerchantId                   String?
  applePayPaymentProcessingCertificate String?
  autoAcceptOrders                     Boolean?  @default(false)
  autoPrintOrders                      Boolean?  @default(false)
  fulfillmentNotificationsEnabled      Boolean?  @default(true)
  platformPercentFee                   Float?    @default(0.029)
  platformFlatFee                      Float?    @default(0.3)
  defaultTaxRate                       Float?    @default(0.0825)
  deliveryBaseFee                      Float?    @default(4.99)
  // Smart Dispatch - Multi-provider delivery aggregation
  smartDispatchEnabled                 Boolean?  @default(false)
  smartDispatchStrategy                String?   @default("cheapest") // "cheapest" or "fastest"
  createdAt                            DateTime  @default(now())
  updatedAt                            DateTime  @updatedAt
  tenant                               Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// Self-delivery driver management
model Driver {
  id           String           @id @default(uuid())
  tenantId     String
  name         String
  phone        String
  email        String?
  pin          String?          // Simple 4-6 digit PIN for driver app
  isActive     Boolean          @default(true)
  vehicleType  String?          // car, bike, motorcycle
  licensePlate String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  tenant       Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveries   SelfDelivery[]
  locations    DriverLocation[]

  @@unique([tenantId, phone])
  @@index([tenantId])
}

model DriverLocation {
  id        String   @id @default(uuid())
  driverId  String
  lat       Float
  lng       Float
  accuracy  Float?   // GPS accuracy in meters
  heading   Float?   // Direction in degrees
  speed     Float?   // Speed in m/s
  createdAt DateTime @default(now())
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, createdAt])
}

model SelfDelivery {
  id                String    @id @default(uuid())
  orderId           String    @unique
  driverId          String?
  tenantId          String
  status            String    @default("pending") // pending, assigned, picked_up, en_route, delivered, cancelled
  pickupAddress     Json
  dropoffAddress    Json
  customerName      String
  customerPhone     String
  estimatedPickup   DateTime?
  actualPickup      DateTime?
  estimatedDropoff  DateTime?
  actualDropoff     DateTime?
  deliveryNotes     String?
  driverNotes       String?
  deliveryFee       Float     @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  driver            Driver?   @relation(fields: [driverId], references: [id], onDelete: SetNull)

  @@index([tenantId, status])
  @@index([driverId])
}

// Group Order - Allows multiple people to order together with individual payments
model GroupOrder {
  id                    String      @id @default(uuid())
  tenantId              String
  sessionCode           String      @unique   // Short shareable code (e.g., "LR-ABC123")

  // Group info
  name                  String?               // Legacy field (use companyName)
  companyName           String?               // Company/Office name for the group order
  organizerName         String
  organizerEmail        String?
  organizerPhone        String?
  organizerCustomerId   String?               // Link to Customer who created the order

  // Fulfillment (shared by all orders in the group)
  fulfillmentMethod     String      @default("pickup")
  deliveryAddress       Json?
  scheduledPickupTime   DateTime?

  // Status tracking
  status                String      @default("open")  // open, closed, fulfilled, cancelled
  expiresAt             DateTime              // Auto-close after expiration
  closedAt              DateTime?

  // Aggregates (updated as orders are added)
  orderCount            Int         @default(0)
  totalAmount           Float       @default(0)

  // "I'm Buying" feature - sponsor pays for everyone
  isSponsoredOrder      Boolean     @default(false)  // Organizer pays for all
  sponsorName           String?                       // "Rob's buying!" display name
  sponsorCustomerId     String?                       // Link to paying customer
  sponsorPaidAt         DateTime?                     // When sponsor completed payment

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  tenant                Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders                Order[]
  invitations           GroupOrderInvitation[]
  organizerCustomer     Customer?   @relation("OrganizerGroupOrders", fields: [organizerCustomerId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([sessionCode])
  @@index([status])
  @@index([organizerCustomerId])
}

model MenuSection {
  id          String          @id @default(uuid())
  tenantId    String
  name        String
  description String?
  type        MenuSectionType @default(RESTAURANT)
  position    Int             @default(0)
  hero        Boolean         @default(false)
  imageUrl    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menuItems   MenuItem[]
}

enum MenuSectionType {
  RESTAURANT
  BAKERY
  GROCERY
  BEVERAGE
  SPECIAL
  OTHER
}

model FrontendSection {
  id          String              @id @default(uuid())
  tenantId    String
  name        String // e.g., "Grocery Store Banner", "Promotional Billboard"
  type        FrontendSectionType
  position    Int                 @default(0) // Display order on page
  enabled     Boolean             @default(true)
  content     Json? // Flexible content: title, subtitle, image, CTA, etc.
  insertAfter Int? // Insert after which menu section index (null = before all sections)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, position])
}

enum FrontendSectionType {
  HERO_BANNER // Top hero section
  PROMOTIONAL_BANNER // Promotional billboard
  GROCERY_BANNER // Grocery store link banner
  BUNDLE_SHOWCASE // Featured bundle/package
  CUSTOM_HTML // Custom content
}

model Customer {
  id                       String            @id @default(uuid())
  tenantId                 String
  name                     String?
  email                    String?
  phone                    String?
  emailVerified            DateTime?
  loyaltyPoints            Int               @default(0)
  membershipTier           String?
  accessibilityPreferences Json?
  stripeCustomerId         String?           // Stripe Customer ID for saved payment methods
  companyName              String?           // Last used company/office name for group orders
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  tenant                   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders                   Order[]
  sessions                 CustomerSession[]
  contacts                 CustomerContact[] // Saved contacts for group orders
  organizedGroupOrders     GroupOrder[]      @relation("OrganizerGroupOrders")

  @@index([tenantId, email])
  @@index([tenantId, phone])
  @@index([stripeCustomerId])
}

model IntegrationLog {
  id        String   @id @default(uuid())
  tenantId  String
  source    String
  level     String   @default("info")
  message   String?
  payload   Json?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model CustomerSession {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([tenantId, token])
}

// MLM Associate Program Models
enum AssociateStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

enum CommissionType {
  SUBSCRIPTION
  ORDER_VOLUME
  REFERRAL
  DOWNLINE_BONUS
  HOSTING
  TEMPLATE_SALE
  DIGITAL_MENU
  MARKETING_APP
  MINI_BODEGA
  OTHER
}

enum AssociateRank {
  REP
  SENIOR_REP
  SUPERVISOR
  MANAGER
  SENIOR_MANAGER
  DIRECTOR
  SENIOR_DIRECTOR
  VP
  SVP
}

enum ProductType {
  ORDERING_SYSTEM
  WEB_HOSTING
  DIGITAL_MENU
  MARKETING_APP
  WEBSITE_TEMPLATE
  MINI_BODEGA
}

enum AchievementType {
  FIRST_SALE
  TEN_SALES
  HUNDRED_SALES
  THOUSAND_SALES
  FIRST_RECRUIT
  THREE_RECRUITS
  TEN_RECRUITS
  FIFTY_RECRUITS
  HUNDRED_RECRUITS
  FIRST_COMMISSION
  THOUSAND_EARNED
  TEN_THOUSAND_EARNED
  HUNDRED_THOUSAND_EARNED
  FIRST_ORDERING_SALE
  FIRST_HOSTING_SALE
  FIRST_TEMPLATE_SALE
  MONTHLY_GOAL
  QUARTERLY_GOAL
  YEARLY_GOAL
  TRAINING_COMPLETE
  SALES_CERTIFIED
  PRODUCT_EXPERT
  TEAM_PLAYER
  MENTOR
  LEADER
}

model Associate {
  id               String          @id @default(uuid())
  email            String          @unique
  password         String // hashed password
  name             String
  phone            String?
  referralCode     String          @unique
  sponsorId        String? // Parent associate (self-referencing)
  level            Int             @default(1) // Depth in downline tree
  status           AssociateStatus @default(ACTIVE)
  rank             AssociateRank   @default(REP)
  rankPoints       Int             @default(0)
  totalRecruits    Int             @default(0)
  activeRecruits   Int             @default(0)
  promotedAt       DateTime?
  nextRank         AssociateRank?
  totalEarnings    Float           @default(0)
  monthlyEarnings  Float           @default(0)
  lifetimeEarnings Float           @default(0)
  totalCommissions Float           @default(0)
  totalPaid        Float           @default(0)
  totalPending     Float           @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Self-referencing for downline tree
  sponsor  Associate?  @relation("AssociateTree", fields: [sponsorId], references: [id], onDelete: SetNull)
  downline Associate[] @relation("AssociateTree")

  // Related records
  referrals           TenantReferral[]
  commissions         Commission[]
  achievements        Achievement[]
  sales               Sale[]
  productReferrals    ProductReferral[]
  trainingProgress    TrainingProgress[]
  contestParticipants ContestParticipant[]
  sentMessages        TeamMessage[]        @relation("SentMessages")
  receivedMessages    TeamMessage[]        @relation("ReceivedMessages")
  meetingsHosted      Meeting[]
  meetingAttendances  MeetingAttendee[]
  leaderboardEntries  LeaderboardEntry[]
  announcementReads   AnnouncementRead[]

  @@index([email])
  @@index([referralCode])
  @@index([sponsorId])
  @@index([status])
  @@index([rank])
}

model TenantReferral {
  id             String    @id @default(uuid())
  tenantId       String
  associateId    String
  referralCode   String // The code used to refer this tenant
  commissionRate Float     @default(0.10) // 10% of subscription fee
  status         String    @default("pending") // pending, approved, active, cancelled
  approvedAt     DateTime?
  activatedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  associate Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([tenantId, associateId]) // One referral per tenant-associate pair
  @@index([tenantId])
  @@index([associateId])
  @@index([referralCode])
  @@index([status])
}

model Commission {
  id           String           @id @default(uuid())
  associateId  String
  tenantId     String?
  orderId      String?
  referralId   String?
  productType  ProductType?
  amount       Float
  type         CommissionType
  status       CommissionStatus @default(PENDING)
  description  String?
  paidAt       DateTime?
  paymentNotes String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  associate Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([tenantId])
  @@index([orderId])
  @@index([referralId])
  @@index([type])
  @@index([productType])
  @@index([status])
  @@index([createdAt])
}

model Achievement {
  id          String          @id @default(uuid())
  associateId String
  type        AchievementType
  title       String
  description String
  icon        String // Emoji or icon URL
  points      Int             @default(0)
  earnedAt    DateTime        @default(now())
  associate   Associate       @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([type])
  @@index([earnedAt])
}

model Sale {
  id            String      @id @default(uuid())
  associateId   String
  productType   ProductType
  productId     String? // Tenant ID, hosting account ID, etc.
  customerName  String
  customerEmail String?
  amount        Float
  commission    Float
  status        String      @default("pending")
  soldAt        DateTime    @default(now())
  associate     Associate   @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([productType])
  @@index([soldAt])
  @@index([status])
}

model ProductReferral {
  id             String      @id @default(uuid())
  associateId    String
  productType    ProductType
  productId      String // Tenant ID, hosting account, etc.
  referralCode   String
  commissionRate Float
  status         String      @default("pending")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  associate      Associate   @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([productType])
  @@index([productId])
  @@index([referralCode])
  @@index([status])
}

model TrainingProgress {
  id             String    @id @default(uuid())
  associateId    String
  courseId       String
  courseName     String
  progress       Int       @default(0) // 0-100
  completed      Boolean   @default(false)
  completedAt    DateTime?
  certificateUrl String?
  associate      Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([courseId])
  @@index([completed])
}

model Contest {
  id           String               @id @default(uuid())
  name         String
  type         String // "sales", "recruiting", "training"
  startDate    DateTime
  endDate      DateTime
  prize        String
  rules        Json
  participants ContestParticipant[]
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([startDate])
  @@index([endDate])
  @@index([type])
}

model ContestParticipant {
  id          String    @id @default(uuid())
  contestId   String
  associateId String
  score       Float     @default(0)
  rank        Int?
  contest     Contest   @relation(fields: [contestId], references: [id], onDelete: Cascade)
  associate   Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([contestId, associateId])
  @@index([contestId])
  @@index([associateId])
  @@index([rank])
}

model Announcement {
  id             String             @id @default(uuid())
  title          String
  content        String
  type           String             @default("general")
  priority       String             @default("normal")
  targetAudience String?
  authorId       String?
  expiresAt      DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  readBy         AnnouncementRead[]

  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@index([expiresAt])
}

model AnnouncementRead {
  id             String       @id @default(uuid())
  announcementId String
  associateId    String
  readAt         DateTime     @default(now())
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  associate      Associate    @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([announcementId, associateId])
  @@index([associateId])
  @@index([announcementId])
}

model Meeting {
  id           String            @id @default(uuid())
  title        String
  description  String?
  type         String            @default("team")
  hostId       String
  scheduledAt  DateTime
  duration     Int               @default(60)
  meetingUrl   String?
  location     String?
  maxAttendees Int?
  status       String            @default("scheduled")
  attendees    MeetingAttendee[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  host         Associate         @relation(fields: [hostId], references: [id], onDelete: Cascade)

  @@index([hostId])
  @@index([scheduledAt])
  @@index([type])
  @@index([status])
}

model MeetingAttendee {
  id          String    @id @default(uuid())
  meetingId   String
  associateId String
  status      String    @default("invited")
  confirmedAt DateTime?
  attendedAt  DateTime?
  notes       String?
  meeting     Meeting   @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  associate   Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([meetingId, associateId])
  @@index([meetingId])
  @@index([associateId])
  @@index([status])
}

model TeamMessage {
  id          String     @id @default(uuid())
  senderId    String
  recipientId String?
  teamId      String?
  subject     String?
  content     String
  type        String     @default("message")
  priority    String     @default("normal")
  read        Boolean    @default(false)
  readAt      DateTime?
  createdAt   DateTime   @default(now())
  sender      Associate  @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  recipient   Associate? @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([recipientId])
  @@index([teamId])
  @@index([read])
  @@index([createdAt])
}

model Leaderboard {
  id        String             @id @default(uuid())
  name      String
  type      String
  period    String             @default("monthly")
  startDate DateTime
  endDate   DateTime
  entries   LeaderboardEntry[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([type])
  @@index([period])
  @@index([startDate])
  @@index([endDate])
}

model LeaderboardEntry {
  id            String      @id @default(uuid())
  leaderboardId String
  associateId   String
  rank          Int
  score         Float
  metadata      Json?
  leaderboard   Leaderboard @relation(fields: [leaderboardId], references: [id], onDelete: Cascade)
  associate     Associate   @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([leaderboardId, associateId])
  @@index([leaderboardId])
  @@index([associateId])
  @@index([rank])
}

// Ecosystem Sync & Communication
model TenantSync {
  id          String    @id @default(uuid())
  tenantId    String
  productType String // 'SMP', 'ORDERING', 'MARKETING_APP', etc.
  lastSyncAt  DateTime?
  syncStatus  String    @default("pending") // pending, syncing, success, error
  syncError   String?
  syncConfig  Json? // Product-specific sync configuration
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, productType])
  @@index([tenantId])
  @@index([productType])
}

model EcosystemEvent {
  id          String    @id @default(uuid())
  tenantId    String?
  eventType   String // 'order_created', 'menu_updated', 'sync_completed', etc.
  source      String // 'ORDERING', 'SMP', 'MARKETING_APP', etc.
  target      String? // Target product if cross-product event
  payload     Json?
  processed   Boolean   @default(false)
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  tenant      Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([eventType])
  @@index([source])
  @@index([processed])
  @@index([createdAt])
}

// CRM - Leads & Deals Pipeline
model Lead {
  id                  String    @id @default(uuid())
  companyName         String
  contactName         String
  contactEmail        String
  contactPhone        String?
  status              String    @default("new") // 'new', 'in_progress', 'closing', 'converted', 'lost'
  dealValue           Float?
  probability         Int       @default(50) // 0-100
  nextAction          DateTime?
  nextActionNote      String?
  notes               String?
  tags                String[]  @default([])
  proposals           Json? // Array of {name, url, date, version}
  prototypes          Json? // Array of {name, url, description}
  convertedToTenantId String?   @unique
  convertedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  convertedToTenant   Tenant?   @relation("LeadToTenant", fields: [convertedToTenantId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@index([nextAction])
}

// Product Catalog
model Product {
  id            String          @id @default(uuid())
  name          String
  slug          String          @unique
  description   String?
  category      String          @default("core") // "core", "addon", "premium"
  type          ProductType     // Keep for backward compatibility
  icon          String? // Icon name or URL
  color         String? // Hex color for UI

  // Base pricing (fallback if no tiers)
  monthlyPrice  Float?
  setupFee      Float           @default(0)

  // Features list
  features      String[]        @default([])

  // Stripe integration
  stripeProductId String?

  // Status
  status        String          @default("active") // 'active', 'beta', 'coming_soon', 'deprecated'
  isActive      Boolean         @default(true)
  sortOrder     Int             @default(0)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  pricingTiers  ProductPricingTier[]
  subscriptions TenantProduct[]

  @@index([type])
  @@index([status])
  @@index([category])
  @@index([isActive])
}

model ProductPricingTier {
  id              String   @id @default(uuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  name            String   // "Basic", "Pro", "Enterprise"
  slug            String   // "basic", "pro", "enterprise"
  monthlyPrice    Float
  yearlyPrice     Float?   // Optional annual discount
  setupFee        Float    @default(0)

  features        String[] // Features included in this tier
  limits          Json?    // { orders: 500, users: 5 }

  stripePriceId   String?  // Monthly price ID
  stripeYearlyPriceId String?

  isPopular       Boolean  @default(false)  // Show "Popular" badge
  sortOrder       Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenantProducts  TenantProduct[]

  @@unique([productId, slug])
  @@index([productId])
  @@index([isPopular])
}

// Tenant Product Subscriptions
model TenantProduct {
  id           String    @id @default(uuid())
  tenantId     String
  tenant       Tenant    @relation("TenantProducts", fields: [tenantId], references: [id], onDelete: Cascade)
  productId    String
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  tierId       String?   // If using pricing tier
  tier         ProductPricingTier? @relation(fields: [tierId], references: [id], onDelete: SetNull)

  status       String    @default("active") // 'active', 'paused', 'cancelled', 'trial', 'prepaid', 'past_due'
  billingCycle String    @default("monthly") // 'monthly', 'yearly'

  // Stripe subscription
  stripeSubscriptionId    String?
  stripeSubscriptionItemId String?
  currentPeriodStart      DateTime?
  currentPeriodEnd        DateTime?

  // Pricing snapshot (in case pricing changes)
  monthlyAmount   Float    @default(0)

  subscribedAt DateTime  @default(now())
  cancelledAt  DateTime?
  cancelReason String?
  trialEndsAt  DateTime?
  expiresAt    DateTime? // For prepaid subscriptions (e.g., Sept 9, 2027)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([tenantId, productId])
  @@index([tenantId])
  @@index([productId])
  @@index([tierId])
  @@index([status])
  @@index([billingCycle])
  @@index([expiresAt])
}

model CRMActivity {
  id           String    @id @default(uuid())
  tenantId     String?
  activityType String // 'call', 'email', 'meeting', 'note', 'task', 'status_change'
  title        String
  description  String?
  assignedTo   String? // User ID or email
  dueDate      DateTime?
  completed    Boolean   @default(false)
  completedAt  DateTime?
  metadata     Json? // Additional activity data
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  tenant       Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([activityType])
  @@index([assignedTo])
  @@index([completed])
  @@index([dueDate])
}

model CRMNote {
  id        String   @id @default(uuid())
  tenantId  String
  author    String // User ID or email
  content   String
  tags      String[] @default([])
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([author])
  @@index([pinned])
  @@index([createdAt])
}

enum TemplateType {
  RESTAURANT
  BAKERY
  COFFEE_SHOP
  GROCERY
  GYM
  CAR_SHOP
  WASH_SERVICE
  CUSTOM
}

model TenantTemplate {
  id              String   @id @default(cuid())
  tenantId        String?  @unique
  tenant          Tenant?  @relation(fields: [tenantId], references: [id])
  name            String
  type            TemplateType @default(RESTAURANT)
  isGlobal        Boolean  @default(false)
  blocks          TenantBlock[]
  settings        TenantTemplateSettings?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model TenantBlock {
  id              String   @id @default(cuid())
  templateId      String
  template        TenantTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  type            String   // HERO, MENU_SECTION, FEATURED_ITEMS, etc.
  title           String?
  subtitle        String?
  badgeText       String?
  ctaText         String?
  ctaLink         String?
  config          Json     @default("{}")
  position        Int      @default(0)
  active          Boolean  @default(true)
  menuItems       TenantBlockMenuItem[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model TenantBlockMenuItem {
  id              String   @id @default(cuid())
  blockId         String
  block           TenantBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)
  menuItemId      String
  menuItem        MenuItem @relation(fields: [menuItemId], references: [id])
  displayOrder    Int      @default(0)
  createdAt       DateTime @default(now())

  @@unique([blockId, menuItemId])
}

model TenantTemplateSettings {
  id                  String   @id @default(cuid())
  templateId          String   @unique
  template            TenantTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Background
  backgroundGradient  String   @default("linear-gradient(180deg, #1c1917 0%, #292524 50%, #1c1917 100%)")
  backgroundPattern   String?
  patternOpacity      Float    @default(0.1)
  patternSize         String?

  // Colors
  primaryColor        String   @default("#dc2626")
  secondaryColor      String   @default("#f59e0b")

  // Effects
  animation           String?
  glowEffect          Boolean  @default(false)
  particleEffect      String?

  // Card Styling
  cardStyle           String   @default("dark-red")
  cardImageEffect     String   @default("soft-shadow")
  cardBackground      String?  // Custom uploaded background

  // Typography
  headingFont         String   @default("Bebas Neue")
  bodyFont            String   @default("Inter")

  // Branding
  logoUrl             String?
  logoSize            String   @default("medium")
  faviconUrl          String?
  businessName        String?
  tagline             String?

  updatedAt           DateTime @updatedAt
}

// Customer Contacts - for storing coworkers/contacts for group orders
model CustomerContact {
  id          String   @id @default(uuid())
  customerId  String
  tenantId    String
  name        String
  email       String
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invitations GroupOrderInvitation[]

  @@unique([customerId, email]) // One contact per email per customer
  @@index([customerId])
  @@index([tenantId])
}

// Group Order Invitations - tracks who was invited and their status
model GroupOrderInvitation {
  id              String   @id @default(uuid())
  groupOrderId    String
  contactId       String?  // Optional - may be invited by email only
  email           String
  name            String
  token           String   @unique @default(uuid()) // For auto-fill on join link
  status          String   @default("pending") // pending, sent, ordered
  invitedAt       DateTime @default(now())
  orderedAt       DateTime?
  orderId         String?  // Links to the order once placed

  groupOrder      GroupOrder       @relation(fields: [groupOrderId], references: [id], onDelete: Cascade)
  contact         CustomerContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@unique([groupOrderId, email]) // One invitation per email per group order
  @@index([groupOrderId])
  @@index([token])
  @@index([status])
}

// VPS Dashboard - AI Chat History
model VPSChatSession {
  id        String           @id @default(uuid())
  userId    String           // super_admin user ID
  panelType String           // 'claude', 'ollama', 'workflow', 'aider'
  title     String?          // Auto-generated from first message
  model     String?          // Model used (sonnet, opus, haiku, llama3.2, etc.)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  messages  VPSChatMessage[]

  @@index([userId])
  @@index([panelType])
  @@index([createdAt])
}

model VPSChatMessage {
  id        String         @id @default(uuid())
  sessionId String
  role      String         // 'user', 'assistant', 'system'
  content   String         @db.Text
  createdAt DateTime       @default(now())
  session   VPSChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

// ============================================
// WASH SERVICE MODELS (Rhino Power Washing)
// ============================================

// Fleet company (B2B customer for wash services)
model Fleet {
  id           String        @id @default(uuid())
  tenantId     String
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  contactName  String?
  email        String?
  phone        String?
  address      String?
  pricePerWash Decimal       @db.Decimal(10, 2) @default(25.00)
  notes        String?
  trucks       Truck[]
  invoices     WashInvoice[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([tenantId])
}

// Individual truck with QR code
model Truck {
  id           String       @id @default(uuid())
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fleetId      String
  fleet        Fleet        @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  qrCode       String       @unique // UUID for QR scanning
  truckNumber  String       // Fleet's internal number (e.g., "T-001")
  description  String?      // "White Freightliner", etc.
  licensePlate String?
  washes       WashRecord[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([tenantId])
  @@index([fleetId])
  @@index([qrCode])
}

// Simple wash record - one per wash
model WashRecord {
  id         String       @id @default(uuid())
  tenantId   String
  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  truckId    String
  truck      Truck        @relation(fields: [truckId], references: [id], onDelete: Cascade)
  employeeId String
  employee   WashEmployee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  invoiceId  String?
  invoice    WashInvoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  price      Decimal      @db.Decimal(10, 2)
  notes      String?
  washedAt   DateTime     @default(now())
  createdAt  DateTime     @default(now())

  @@index([tenantId])
  @@index([truckId])
  @@index([employeeId])
  @@index([invoiceId])
  @@index([washedAt])
}

// Employee (washer)
model WashEmployee {
  id         String          @id @default(uuid())
  tenantId   String
  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name       String
  phone      String
  pin        String          // Last 4 digits of phone for login
  role       String          @default("employee") // owner, staff, employee
  hourlyRate Decimal?        @db.Decimal(10, 2)
  active     Boolean         @default(true)
  washes     WashRecord[]
  shifts     EmployeeShift[]
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@unique([tenantId, phone])
  @@unique([tenantId, pin])
  @@index([tenantId])
}

// Employee shift (clock in/out)
model EmployeeShift {
  id         String       @id @default(uuid())
  tenantId   String
  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId String
  employee   WashEmployee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  clockIn    DateTime
  clockOut   DateTime?
  createdAt  DateTime     @default(now())

  @@index([tenantId])
  @@index([employeeId])
  @@index([clockIn])
}

// Invoice for fleet
model WashInvoice {
  id            String       @id @default(uuid())
  tenantId      String
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fleetId       String
  fleet         Fleet        @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  invoiceNumber String       @unique
  washes        WashRecord[]
  washCount     Int
  pricePerWash  Decimal      @db.Decimal(10, 2)
  subtotal      Decimal      @db.Decimal(10, 2)
  tax           Decimal      @db.Decimal(10, 2) @default(0)
  total         Decimal      @db.Decimal(10, 2)
  status        String       @default("draft") // draft, sent, paid
  periodStart   DateTime
  periodEnd     DateTime
  dueDate       DateTime?
  paidAt        DateTime?
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([tenantId])
  @@index([fleetId])
  @@index([status])
}

// Supply usage tracking (optional)
model SupplyLog {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId String?
  supplyName String   // "Soap", "Degreaser", etc.
  quantity   Decimal  @db.Decimal(10, 2)
  unit       String   // "gallons", "bottles", etc.
  notes      String?
  loggedAt   DateTime @default(now())

  @@index([tenantId])
  @@index([loggedAt])
}
