// Prisma schema converted for PostgreSQL
// learn more at https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TenantStatus {
  PENDING_REVIEW
  READY_FOR_APPROVAL
  APPROVED
  LIVE
  PAUSED
  ARCHIVED
}

model MenuItem {
  id                      String        @id @default(uuid())
  tenantId                String
  menuSectionId           String?
  name                    String
  description             String
  price                   Float
  category                String        @default("general")
  image                   String?
  gallery                 Json?
  available               Boolean       @default(true)
  isFeatured              Boolean       @default(false)
  tags                    String[]      @default([])
  customizationRemovals   String[]      @default([])
  customizationAddons     Json?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  tenant                  Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  section                 MenuSection?  @relation(fields: [menuSectionId], references: [id], onDelete: SetNull)
  orders                  OrderItem[]
}

model CateringPackage {
  id                      String        @id @default(uuid())
  tenantId                String
  name                    String
  description             String
  pricePerGuest           Float
  image                   String?
  badge                   String?
  available               Boolean       @default(true)
  displayOrder            Int           @default(0)
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  tenant                  Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Order {
  id               String        @id @default(uuid())
  tenantId         String
  customerId       String?
  subtotalAmount   Float?
  taxAmount        Float?        @default(0)
  deliveryFee      Float?        @default(0)
  tipAmount        Float?        @default(0)
  platformFee      Float?        @default(0)
  totalAmount      Float
  paymentIntentId  String?       @unique
  status           String        @default("pending")
  fulfillmentMethod String       @default("pickup")
  deliveryPartner  String?
  paymentMethod    String?
  customerName     String?
  customerEmail    String?
  customerPhone    String?
  notes            String?
  acknowledgedAt   DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer         Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items            OrderItem[]
}

model PaymentSession {
  id              String   @id @default(uuid())
  tenantId        String
  paymentIntentId String   @unique
  amount          Int
  currency        String   @default("usd")
  status          String   @default("pending")
  orderId         String?
  orderData       Json
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([paymentIntentId])
  @@index([status])
}

model OrderItem {
  id         String   @id @default(uuid())
  menuItemId String
  tenantId   String
  orderId    String
  quantity   Int
  price      Float
  notes      String?
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Tenant {
  id               String             @id @default(uuid())
  name             String
  slug             String             @unique
  domain           String?
  customDomain     String?
  contactEmail     String?
  contactPhone     String?
  addressLine1     String?
  addressLine2     String?
  city             String?
  state            String?
  postalCode       String?
  country          String?
  logoUrl          String?
  heroImageUrl     String?
  heroTitle        String?
  heroSubtitle     String?
  primaryColor     String?           @default("#dc2626")
  secondaryColor   String?           @default("#f59e0b")
  status           TenantStatus      @default(PENDING_REVIEW)
  statusNotes      String?
  statusUpdatedAt  DateTime?         @default(now())
  subscriptionPlan String?
  subscriptionMonthlyFee Float       @default(0)
  subscriptionAddons  String[]       @default([])
  featureFlags     String[]          @default([])
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  settings         TenantSettings?
  integrations     TenantIntegration?
  customers        Customer[]
  customerSessions CustomerSession[]
  menuSections     MenuSection[]
  menuItems        MenuItem[]
  cateringPackages CateringPackage[]
  orders           Order[]
  orderItems       OrderItem[]
  integrationLogs  IntegrationLog[]
  paymentSessions  PaymentSession[]

  @@index([status])
}

model TenantSettings {
  id                     String   @id @default(uuid())
  tenantId               String   @unique
  tagline                String?
  about                  String?
  socialInstagram        String?
  socialFacebook         String?
  socialTikTok           String?
  socialYouTube          String?
  deliveryRadiusMi       Int?     @default(5)
  minimumOrderValue      Float?   @default(0)
  currency               String?  @default("USD")
  timeZone               String?  @default("America/Los_Angeles")
  operatingHours         Json?
  membershipProgram      Json?
  upsellBundles          Json?
  accessibilityDefaults  Json?
  branding               Json?
  cateringTabConfig      Json?
  isOpen                 Boolean? @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  tenant                 Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantIntegration {
  id                               String   @id @default(uuid())
  tenantId                         String   @unique
  doorDashStoreId                  String?
  doorDashOAuthToken               String?
  cloverMerchantId                 String?
  cloverApiKey                     String?
  stripeAccountId                  String?
  stripeOnboardingComplete         Boolean? @default(false)
  stripeChargesEnabled             Boolean? @default(false)
  stripePayoutsEnabled             Boolean? @default(false)
  stripeDetailsSubmitted           Boolean? @default(false)
  stripeOnboardedAt                DateTime?
  cloverAccessToken                String?
  squareLocationId                 String?
  squareAccessToken                String?
  taxProvider                      String?  @default("builtin")
  taxConfig                        Json?
  paymentProcessor                 String?  @default("stripe")
  paymentConfig                    Json?
  printerType                      String?  @default("bluetooth")
  printerEndpoint                  String?
  printerConfig                    Json?
  applePayMerchantId               String?
  applePayPaymentProcessingCertificate String?
  autoAcceptOrders                 Boolean? @default(false)
  autoPrintOrders                  Boolean? @default(false)
  fulfillmentNotificationsEnabled  Boolean? @default(true)
  platformPercentFee               Float?   @default(0.029)
  platformFlatFee                  Float?   @default(0.3)
  defaultTaxRate                   Float?   @default(0.0825)
  deliveryBaseFee                  Float?   @default(4.99)
  createdAt                        DateTime @default(now())
  updatedAt                        DateTime @updatedAt
  tenant                           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model MenuSection {
  id          String          @id @default(uuid())
  tenantId    String
  name        String
  description String?
  type        MenuSectionType @default(RESTAURANT)
  position    Int             @default(0)
  hero        Boolean         @default(false)
  imageUrl    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menuItems   MenuItem[]
}

enum MenuSectionType {
  RESTAURANT
  BAKERY
  GROCERY
  BEVERAGE
  SPECIAL
  OTHER
}

model Customer {
  id                      String   @id @default(uuid())
  tenantId                String
  name                    String?
  email                   String?
  phone                   String?
  emailVerified           DateTime?
  loyaltyPoints           Int      @default(0)
  membershipTier          String?
  accessibilityPreferences Json?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  tenant                  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders                  Order[]
  sessions                CustomerSession[]

  @@index([tenantId, email])
  @@index([tenantId, phone])
}

model IntegrationLog {
  id        String   @id @default(uuid())
  tenantId  String
  source    String
  level     String   @default("info")
  message   String?
  payload   Json?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model CustomerSession {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([tenantId, token])
}
