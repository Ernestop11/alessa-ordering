// Prisma schema converted for PostgreSQL
// learn more at https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TenantStatus {
  PENDING_REVIEW
  READY_FOR_APPROVAL
  APPROVED
  LIVE
  PAUSED
  ARCHIVED
}

model MenuItem {
  id                    String       @id @default(uuid())
  tenantId              String
  menuSectionId         String?
  name                  String
  description           String
  price                 Float
  category              String       @default("general")
  image                 String?
  gallery               Json?
  available             Boolean      @default(true)
  isFeatured            Boolean      @default(false)
  tags                  String[]     @default([])
  customizationRemovals String[]     @default([])
  customizationAddons   Json?
  // Time-specific availability (e.g., Taco Tuesday)
  timeSpecificEnabled   Boolean      @default(false)
  timeSpecificDays      Int[]        @default([]) // 0=Sunday, 1=Monday, etc.
  timeSpecificStartTime String? // e.g., "11:00"
  timeSpecificEndTime   String? // e.g., "15:00"
  timeSpecificPrice     Float? // Override price during time window
  timeSpecificLabel     String? // e.g., "Taco Tuesday Special"
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  tenant                Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  section               MenuSection? @relation(fields: [menuSectionId], references: [id], onDelete: SetNull)
  orders                OrderItem[]
}

model CateringPackage {
  id                    String           @id @default(uuid())
  tenantId              String
  cateringSectionId     String?
  name                  String
  description           String
  pricePerGuest         Float
  price                 Float?
  category              String           @default("popular")
  image                 String?
  gallery               Json?
  badge                 String?
  customizationRemovals String[]         @default([])
  customizationAddons   Json?
  available             Boolean          @default(true)
  displayOrder          Int              @default(0)
  // Time-specific availability (e.g., Weekend Special)
  timeSpecificEnabled   Boolean          @default(false)
  timeSpecificDays      Int[]            @default([]) // 0=Sunday, 1=Monday, etc.
  timeSpecificStartTime String? // e.g., "11:00"
  timeSpecificEndTime   String? // e.g., "15:00"
  timeSpecificPrice     Float? // Override price during time window
  timeSpecificLabel     String? // e.g., "Weekend Special"
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  tenant                Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  section               CateringSection? @relation(fields: [cateringSectionId], references: [id], onDelete: SetNull)
}

model CateringSection {
  id          String            @id @default(uuid())
  tenantId    String
  name        String
  description String?
  position    Int               @default(0)
  imageUrl    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  tenant      Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  packages    CateringPackage[]
}

model Order {
  id                String      @id @default(uuid())
  tenantId          String
  customerId        String?
  subtotalAmount    Float?
  taxAmount         Float?      @default(0)
  deliveryFee       Float?      @default(0)
  tipAmount         Float?      @default(0)
  platformFee       Float?      @default(0)
  totalAmount       Float
  paymentIntentId   String?     @unique
  status            String      @default("pending")
  fulfillmentMethod String      @default("pickup")
  deliveryPartner   String?
  paymentMethod     String?
  customerName      String?
  customerEmail     String?
  customerPhone     String?
  notes             String?
  acknowledgedAt    DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer          Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items             OrderItem[]
}

model CateringInquiry {
  id            String    @id @default(uuid())
  tenantId      String
  customerName  String
  customerEmail String
  customerPhone String
  eventDate     DateTime?
  guestCount    Int?
  message       String?
  status        String    @default("new") // new, contacted, quoted, booked, cancelled
  respondedAt   DateTime?
  responseNotes String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
}

model PaymentSession {
  id              String   @id @default(uuid())
  tenantId        String
  paymentIntentId String   @unique
  amount          Int
  currency        String   @default("usd")
  status          String   @default("pending")
  orderId         String?
  orderData       Json
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([paymentIntentId])
  @@index([status])
}

model TaxRemittance {
  id                String   @id @default(uuid())
  tenantId           String
  periodStart        DateTime
  periodEnd          DateTime
  totalTaxCollected  Float
  totalTaxRemitted   Float   @default(0)
  status             String   @default("pending") // pending, processing, completed, failed
  remittanceDate     DateTime?
  remittanceMethod   String?  // automatic, manual
  remittanceReference String? // Transaction ID or reference number
  reportData         Json?    // Tax report details
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([periodStart, periodEnd])
}

model OrderItem {
  id         String   @id @default(uuid())
  menuItemId String
  tenantId   String
  orderId    String
  quantity   Int
  price      Float
  notes      String?
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Tenant {
  id                     String             @id @default(uuid())
  name                   String
  slug                   String             @unique
  domain                 String?
  customDomain           String?
  contactEmail           String?
  contactPhone           String?
  addressLine1           String?
  addressLine2           String?
  city                   String?
  state                  String?
  postalCode             String?
  country                String?
  logoUrl                String?
  heroImageUrl           String?
  heroTitle              String?
  heroSubtitle           String?
  primaryColor           String?            @default("#dc2626")
  secondaryColor         String?            @default("#f59e0b")
  status                 TenantStatus       @default(PENDING_REVIEW)
  statusNotes            String?
  statusUpdatedAt        DateTime?          @default(now())
  subscriptionPlan       String?
  subscriptionMonthlyFee Float              @default(0)
  subscriptionAddons     String[]           @default([])
  featureFlags           String[]           @default([])
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  settings               TenantSettings?
  integrations           TenantIntegration?
  customers              Customer[]
  customerSessions       CustomerSession[]
  menuSections           MenuSection[]
  menuItems              MenuItem[]
  cateringSections       CateringSection[]
  cateringPackages       CateringPackage[]
  orders                 Order[]
  orderItems             OrderItem[]
  integrationLogs        IntegrationLog[]
  paymentSessions        PaymentSession[]
  cateringInquiries      CateringInquiry[]
  referrals              TenantReferral[]
  tenantSyncs            TenantSync[]
  ecosystemEvents        EcosystemEvent[]
  crmActivities          CRMActivity[]
  crmNotes               CRMNote[]
  convertedFromLead      Lead?              @relation("LeadToTenant")
  productSubscriptions   TenantProduct[]     @relation("TenantProducts")
  taxRemittances         TaxRemittance[]

  @@index([status])
}

model TenantSettings {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  tagline               String?
  about                 String?
  socialInstagram       String?
  socialFacebook        String?
  socialTikTok          String?
  socialYouTube         String?
  deliveryRadiusMi      Int?     @default(5)
  minimumOrderValue     Float?   @default(0)
  currency              String?  @default("USD")
  timeZone              String?  @default("America/Los_Angeles")
  operatingHours        Json?
  membershipProgram     Json?
  upsellBundles         Json?
  rewards               Json? // Array of Reward objects
  emailOffers           Json? // Array of EmailOffer objects
  accessibilityDefaults Json?
  branding              Json?
  cateringTabConfig     Json?
  cateringGallery       String[] @default([])
  rewardsGallery        String[] @default([])
  isOpen                Boolean? @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantIntegration {
  id                                   String    @id @default(uuid())
  tenantId                             String    @unique
  doorDashStoreId                      String?
  doorDashOAuthToken                   String?
  uberClientId                         String?
  uberClientSecret                     String?
  uberSandbox                          Boolean?  @default(true)
  cloverMerchantId                     String?
  cloverApiKey                         String?
  stripeAccountId                      String?
  stripeOnboardingComplete             Boolean?  @default(false)
  stripeChargesEnabled                 Boolean?  @default(false)
  stripePayoutsEnabled                 Boolean?  @default(false)
  stripeDetailsSubmitted               Boolean?  @default(false)
  stripeOnboardedAt                    DateTime?
  cloverAccessToken                    String?
  squareLocationId                     String?
  squareAccessToken                    String?
  taxProvider                          String?   @default("builtin")
  taxConfig                            Json?
  taxRemittanceEnabled                 Boolean?  @default(false)
  taxRemittanceSchedule                String?   @default("monthly") // monthly, quarterly
  taxEscrowAccountId                   String?   // Stripe Connect account for tax escrow
  paymentProcessor                     String?   @default("stripe")
  paymentConfig                        Json?
  printerType                          String?   @default("bluetooth")
  printerEndpoint                      String?
  printerConfig                        Json?
  applePayMerchantId                   String?
  applePayPaymentProcessingCertificate String?
  autoAcceptOrders                     Boolean?  @default(false)
  autoPrintOrders                      Boolean?  @default(false)
  fulfillmentNotificationsEnabled      Boolean?  @default(true)
  platformPercentFee                   Float?    @default(0.029)
  platformFlatFee                      Float?    @default(0.3)
  defaultTaxRate                       Float?    @default(0.0825)
  deliveryBaseFee                      Float?    @default(4.99)
  createdAt                            DateTime  @default(now())
  updatedAt                            DateTime  @updatedAt
  tenant                               Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model MenuSection {
  id          String          @id @default(uuid())
  tenantId    String
  name        String
  description String?
  type        MenuSectionType @default(RESTAURANT)
  position    Int             @default(0)
  hero        Boolean         @default(false)
  imageUrl    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menuItems   MenuItem[]
}

enum MenuSectionType {
  RESTAURANT
  BAKERY
  GROCERY
  BEVERAGE
  SPECIAL
  OTHER
}

model Customer {
  id                       String            @id @default(uuid())
  tenantId                 String
  name                     String?
  email                    String?
  phone                    String?
  emailVerified            DateTime?
  loyaltyPoints            Int               @default(0)
  membershipTier           String?
  accessibilityPreferences Json?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  tenant                   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders                   Order[]
  sessions                 CustomerSession[]

  @@index([tenantId, email])
  @@index([tenantId, phone])
}

model IntegrationLog {
  id        String   @id @default(uuid())
  tenantId  String
  source    String
  level     String   @default("info")
  message   String?
  payload   Json?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model CustomerSession {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([tenantId, token])
}

// MLM Associate Program Models
enum AssociateStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

enum CommissionType {
  SUBSCRIPTION
  ORDER_VOLUME
  REFERRAL
  DOWNLINE_BONUS
  HOSTING
  TEMPLATE_SALE
  DIGITAL_MENU
  MARKETING_APP
  MINI_BODEGA
  OTHER
}

enum AssociateRank {
  REP
  SENIOR_REP
  SUPERVISOR
  MANAGER
  SENIOR_MANAGER
  DIRECTOR
  SENIOR_DIRECTOR
  VP
  SVP
}

enum ProductType {
  ORDERING_SYSTEM
  WEB_HOSTING
  DIGITAL_MENU
  MARKETING_APP
  WEBSITE_TEMPLATE
  MINI_BODEGA
}

enum AchievementType {
  FIRST_SALE
  TEN_SALES
  HUNDRED_SALES
  THOUSAND_SALES
  FIRST_RECRUIT
  THREE_RECRUITS
  TEN_RECRUITS
  FIFTY_RECRUITS
  HUNDRED_RECRUITS
  FIRST_COMMISSION
  THOUSAND_EARNED
  TEN_THOUSAND_EARNED
  HUNDRED_THOUSAND_EARNED
  FIRST_ORDERING_SALE
  FIRST_HOSTING_SALE
  FIRST_TEMPLATE_SALE
  MONTHLY_GOAL
  QUARTERLY_GOAL
  YEARLY_GOAL
  TRAINING_COMPLETE
  SALES_CERTIFIED
  PRODUCT_EXPERT
  TEAM_PLAYER
  MENTOR
  LEADER
}

model Associate {
  id               String          @id @default(uuid())
  email            String          @unique
  password         String // hashed password
  name             String
  phone            String?
  referralCode     String          @unique
  sponsorId        String? // Parent associate (self-referencing)
  level            Int             @default(1) // Depth in downline tree
  status           AssociateStatus @default(ACTIVE)
  rank             AssociateRank   @default(REP)
  rankPoints       Int             @default(0)
  totalRecruits    Int             @default(0)
  activeRecruits   Int             @default(0)
  promotedAt       DateTime?
  nextRank         AssociateRank?
  totalEarnings    Float           @default(0)
  monthlyEarnings  Float           @default(0)
  lifetimeEarnings Float           @default(0)
  totalCommissions Float           @default(0)
  totalPaid        Float           @default(0)
  totalPending     Float           @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Self-referencing for downline tree
  sponsor  Associate?  @relation("AssociateTree", fields: [sponsorId], references: [id], onDelete: SetNull)
  downline Associate[] @relation("AssociateTree")

  // Related records
  referrals           TenantReferral[]
  commissions         Commission[]
  achievements        Achievement[]
  sales               Sale[]
  productReferrals    ProductReferral[]
  trainingProgress    TrainingProgress[]
  contestParticipants ContestParticipant[]
  sentMessages        TeamMessage[]        @relation("SentMessages")
  receivedMessages    TeamMessage[]        @relation("ReceivedMessages")
  meetingsHosted      Meeting[]
  meetingAttendances  MeetingAttendee[]
  leaderboardEntries  LeaderboardEntry[]
  announcementReads   AnnouncementRead[]

  @@index([email])
  @@index([referralCode])
  @@index([sponsorId])
  @@index([status])
  @@index([rank])
}

model TenantReferral {
  id             String    @id @default(uuid())
  tenantId       String
  associateId    String
  referralCode   String // The code used to refer this tenant
  commissionRate Float     @default(0.10) // 10% of subscription fee
  status         String    @default("pending") // pending, approved, active, cancelled
  approvedAt     DateTime?
  activatedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  associate Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([tenantId, associateId]) // One referral per tenant-associate pair
  @@index([tenantId])
  @@index([associateId])
  @@index([referralCode])
  @@index([status])
}

model Commission {
  id           String           @id @default(uuid())
  associateId  String
  tenantId     String?
  orderId      String?
  referralId   String?
  productType  ProductType?
  amount       Float
  type         CommissionType
  status       CommissionStatus @default(PENDING)
  description  String?
  paidAt       DateTime?
  paymentNotes String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  associate Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([tenantId])
  @@index([orderId])
  @@index([referralId])
  @@index([type])
  @@index([productType])
  @@index([status])
  @@index([createdAt])
}

model Achievement {
  id          String          @id @default(uuid())
  associateId String
  type        AchievementType
  title       String
  description String
  icon        String // Emoji or icon URL
  points      Int             @default(0)
  earnedAt    DateTime        @default(now())
  associate   Associate       @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([type])
  @@index([earnedAt])
}

model Sale {
  id            String      @id @default(uuid())
  associateId   String
  productType   ProductType
  productId     String? // Tenant ID, hosting account ID, etc.
  customerName  String
  customerEmail String?
  amount        Float
  commission    Float
  status        String      @default("pending")
  soldAt        DateTime    @default(now())
  associate     Associate   @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([productType])
  @@index([soldAt])
  @@index([status])
}

model ProductReferral {
  id             String      @id @default(uuid())
  associateId    String
  productType    ProductType
  productId      String // Tenant ID, hosting account, etc.
  referralCode   String
  commissionRate Float
  status         String      @default("pending")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  associate      Associate   @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([productType])
  @@index([productId])
  @@index([referralCode])
  @@index([status])
}

model TrainingProgress {
  id             String    @id @default(uuid())
  associateId    String
  courseId       String
  courseName     String
  progress       Int       @default(0) // 0-100
  completed      Boolean   @default(false)
  completedAt    DateTime?
  certificateUrl String?
  associate      Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@index([associateId])
  @@index([courseId])
  @@index([completed])
}

model Contest {
  id           String               @id @default(uuid())
  name         String
  type         String // "sales", "recruiting", "training"
  startDate    DateTime
  endDate      DateTime
  prize        String
  rules        Json
  participants ContestParticipant[]
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([startDate])
  @@index([endDate])
  @@index([type])
}

model ContestParticipant {
  id          String    @id @default(uuid())
  contestId   String
  associateId String
  score       Float     @default(0)
  rank        Int?
  contest     Contest   @relation(fields: [contestId], references: [id], onDelete: Cascade)
  associate   Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([contestId, associateId])
  @@index([contestId])
  @@index([associateId])
  @@index([rank])
}

model Announcement {
  id             String             @id @default(uuid())
  title          String
  content        String
  type           String             @default("general")
  priority       String             @default("normal")
  targetAudience String?
  authorId       String?
  expiresAt      DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  readBy         AnnouncementRead[]

  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@index([expiresAt])
}

model AnnouncementRead {
  id             String       @id @default(uuid())
  announcementId String
  associateId    String
  readAt         DateTime     @default(now())
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  associate      Associate    @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([announcementId, associateId])
  @@index([associateId])
  @@index([announcementId])
}

model Meeting {
  id           String            @id @default(uuid())
  title        String
  description  String?
  type         String            @default("team")
  hostId       String
  scheduledAt  DateTime
  duration     Int               @default(60)
  meetingUrl   String?
  location     String?
  maxAttendees Int?
  status       String            @default("scheduled")
  attendees    MeetingAttendee[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  host         Associate         @relation(fields: [hostId], references: [id], onDelete: Cascade)

  @@index([hostId])
  @@index([scheduledAt])
  @@index([type])
  @@index([status])
}

model MeetingAttendee {
  id          String    @id @default(uuid())
  meetingId   String
  associateId String
  status      String    @default("invited")
  confirmedAt DateTime?
  attendedAt  DateTime?
  notes       String?
  meeting     Meeting   @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  associate   Associate @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([meetingId, associateId])
  @@index([meetingId])
  @@index([associateId])
  @@index([status])
}

model TeamMessage {
  id          String     @id @default(uuid())
  senderId    String
  recipientId String?
  teamId      String?
  subject     String?
  content     String
  type        String     @default("message")
  priority    String     @default("normal")
  read        Boolean    @default(false)
  readAt      DateTime?
  createdAt   DateTime   @default(now())
  sender      Associate  @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  recipient   Associate? @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([recipientId])
  @@index([teamId])
  @@index([read])
  @@index([createdAt])
}

model Leaderboard {
  id        String             @id @default(uuid())
  name      String
  type      String
  period    String             @default("monthly")
  startDate DateTime
  endDate   DateTime
  entries   LeaderboardEntry[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([type])
  @@index([period])
  @@index([startDate])
  @@index([endDate])
}

model LeaderboardEntry {
  id            String      @id @default(uuid())
  leaderboardId String
  associateId   String
  rank          Int
  score         Float
  metadata      Json?
  leaderboard   Leaderboard @relation(fields: [leaderboardId], references: [id], onDelete: Cascade)
  associate     Associate   @relation(fields: [associateId], references: [id], onDelete: Cascade)

  @@unique([leaderboardId, associateId])
  @@index([leaderboardId])
  @@index([associateId])
  @@index([rank])
}

// Ecosystem Sync & Communication
model TenantSync {
  id          String    @id @default(uuid())
  tenantId    String
  productType String // 'SMP', 'ORDERING', 'MARKETING_APP', etc.
  lastSyncAt  DateTime?
  syncStatus  String    @default("pending") // pending, syncing, success, error
  syncError   String?
  syncConfig  Json? // Product-specific sync configuration
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, productType])
  @@index([tenantId])
  @@index([productType])
}

model EcosystemEvent {
  id          String    @id @default(uuid())
  tenantId    String?
  eventType   String // 'order_created', 'menu_updated', 'sync_completed', etc.
  source      String // 'ORDERING', 'SMP', 'MARKETING_APP', etc.
  target      String? // Target product if cross-product event
  payload     Json?
  processed   Boolean   @default(false)
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  tenant      Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([eventType])
  @@index([source])
  @@index([processed])
  @@index([createdAt])
}

// CRM - Leads & Deals Pipeline
model Lead {
  id                String    @id @default(uuid())
  companyName       String
  contactName       String
  contactEmail      String
  contactPhone      String?
  status            String    @default("new") // 'new', 'in_progress', 'closing', 'converted', 'lost'
  dealValue         Float?
  probability       Int       @default(50) // 0-100
  nextAction        DateTime?
  nextActionNote    String?
  notes             String?
  tags              String[]  @default([])
  proposals         Json?     // Array of {name, url, date, version}
  prototypes        Json?     // Array of {name, url, description}
  convertedToTenantId String? @unique
  convertedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  convertedToTenant Tenant?   @relation("LeadToTenant", fields: [convertedToTenantId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@index([nextAction])
}

// Product Catalog
model Product {
  id            String          @id @default(uuid())
  name          String
  slug          String          @unique
  type          ProductType
  description   String?
  status        String          @default("active") // 'active', 'beta', 'coming_soon', 'deprecated'
  monthlyPrice  Float?
  setupFee      Float?
  features      String[]        @default([])
  icon          String?         // Emoji or icon name
  color         String?         // Hex color for UI
  order         Int             @default(0) // Display order
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  subscriptions TenantProduct[]

  @@index([type])
  @@index([status])
}

// Tenant Product Subscriptions
model TenantProduct {
  id            String    @id @default(uuid())
  tenantId      String
  productId     String
  status        String    @default("active") // 'active', 'paused', 'cancelled', 'trial', 'prepaid'
  subscribedAt DateTime  @default(now())
  cancelledAt   DateTime?
  trialEndsAt   DateTime?
  expiresAt     DateTime? // For prepaid subscriptions (e.g., Sept 9, 2027)
  tenant        Tenant    @relation("TenantProducts", fields: [tenantId], references: [id], onDelete: Cascade)
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([tenantId, productId])
  @@index([tenantId])
  @@index([productId])
  @@index([status])
  @@index([expiresAt])
}

model CRMActivity {
  id           String    @id @default(uuid())
  tenantId     String?
  activityType String // 'call', 'email', 'meeting', 'note', 'task', 'status_change'
  title        String
  description  String?
  assignedTo   String? // User ID or email
  dueDate      DateTime?
  completed    Boolean   @default(false)
  completedAt  DateTime?
  metadata     Json? // Additional activity data
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  tenant       Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([activityType])
  @@index([assignedTo])
  @@index([completed])
  @@index([dueDate])
}

model CRMNote {
  id        String   @id @default(uuid())
  tenantId  String
  author    String // User ID or email
  content   String
  tags      String[] @default([])
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([author])
  @@index([pinned])
  @@index([createdAt])
}
